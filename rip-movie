#!/bin/bash -

### Rip Movie
### =========
###
### Rip a movie from a DVD using Handbrake.
###
### `rip-movie -h` for more.


## Variables

aspect_ratio=auto
bitrate=1800
rate=25
bufsize=12500
add_aac=false
foreign=false
scan=false
use_TMDb=false
subtitle_track="scan"
language="eng"
title=1
min_length=1                    # Hours, not minutes as with rip-episodes
outputdir="$HOME/Movies/"


## Functions

_show_help() {
    printf -- "rip-movie [-17abcdflmursto] title\n\n"
    printf -- "Options (and defaults):\n\n"
    printf -- "-1: set x264 bitrate and bufsize values to those for 1080p content\n"
    printf -- "-7: set x264 bitrate and bufsize values to those for 720p content\n"
    printf -- "-a: instead of an AC3 track only, add AAC as the first track\n"
    printf -- "-b: rate: video bitrate (${bitrate})\n"
    printf -- "-c: scan titles of media only\n"
    printf -- "-d: set the movie filename to its name and year using TMDb\n"
    printf -- "-f: assume a foreign film and include all subtitles, not just those that are forced\n"
    printf -- "-l language: iso639-2 language to use for subtitles (and audio if not foreign) (${language})\n"
    printf -- "-m length: mimimum length (in hours) of title to use (${min_length})\n"
    printf -- "-u source_dir: source VIDEO_TS / MKV rip directory to rip the movie from\n"
    printf -- "-r pixel_aspect_ratio: colon-separated ratio (e.g., 16:9) (${aspect_ratio})\n"
    printf -- "-s subtitle_track: subtitle track to rip (${subtitle_track})\n"
    printf -- "-t n: start ripping from title n on disc (longer than ${min_length} hour) (${title})\n"
    printf -- "-o dir: output directory (with trailing slash) (${outputdir})\n\n"
    exit 2
}

_report_error () {
    printf "$(basename $0): $1.\n" >&2
    exit 1
}


## Option parsing

while getopts :17ab:cdr:s:fl:m:t:u:o:h opt; do
    case "$opt" in
        1)    bitrate=5000
              bufsize=25000
              ;;
        7)    bitrate=4000
              bufsize=17500
              ;;
        a)    add_aac=true
              ;;
        b)    bitrate="$OPTARG"
              ;;
        c)    scan=true
              ;;
        d)    use_TMDb=true
              ;;
        f)    foreign=true
              ;;
        l)    language="$OPTARG"
              ;;
        m)    min_length="$OPTARG"
              ;;
        r)    aspect_ratio="$OPTARG"
              ;;
        s)    subtitle_track="$OPTARG"
              ;;
        t)    title="$OPTARG"
              ;;
        u)    source="$OPTARG"
              ;;
        o)    outputdir="$OPTARG"
              ;;
        h)    _show_help
              ;;
        '?')  _report_error "invalid option $OPTARG. rip-movie -h for more info"
              ;;
    esac
done

shift $((OPTIND-1)) # Forget single-letter options now; put main options to front


## Main logic

if [[ -z $1 ]] && ! "$use_TMDb"; then
    _report_error "no output file name found"
fi
movie="$*" # Collect all args as one string together
if "$use_TMDb"; then
    movie=$(find-movie "$source" 2>/dev/null)
    if [[ $? -gt 0 ]]; then
        _report_error "Movie name not found in TMDb"
    fi
fi

if [[ ! -z "$source" ]]; then
    drive="$source"
else
    drive=$(drutil status | grep -Eo '/dev/disk[1-9]')
    # if [[ "$?" -gt 0 ]]; then
    #     _report_error "No disc available; stopping"
    # fi
fi

video_settings="-e x264 -f mkv --modulus 2 -m --x264-preset fast --h264-profile high --h264-level 4.1 -x ratetol=inf:vbv-maxrate=${bufsize}:vbv-bufsize=${bufsize} -b ${bitrate} --decomb --cfr -r${rate} -N${language} -s ${subtitle_track}"

if ! "$foreign"; then
    # "Film isn't foreign, so find the forced subtitles only"
    video_settings="${video_settings} -F --native-dub"
fi

if [[ "$aspect_ratio" == "auto" ]]; then
    video_settings="${video_settings} --strict-anamorphic"
else
    video_settings="${video_settings} --custom-anamorphic --pixel-aspect ${aspect_ratio}"
fi

audio_settings='-R Auto -D 0.0 --audio-fallback ca_aac'

if "$add_aac"; then
    audio_settings="${audio_settings} -6 dpl2,none -E ca_aac,copy:ac3 -B 160"
else
    audio_settings="${audio_settings} -6 none -E copy:ac3"
fi

titles=$(HandBrakeCLI -i "$drive" -t0 2>&1 | awk -F: -v "min=$min_length" 'BEGIN{OFS=":";t=1}/\+ duration:/{if ($2>=min) print t,$2,$3,$4;t++}')

if "$scan"; then
    printf -- "${titles}\n"
else
    main_title=$(printf -- "$titles" | head "-$title" | tail -1 | awk -F: '{print $1}')
    HandBrakeCLI -i "$drive" -t "$main_title" -o "${outputdir}${movie}.mkv" ${video_settings} ${audio_settings} # && ls -lh "$outputdir" && sleep 60 && drutil eject
fi
